<!DOCTYPE html>
<html lang="vi" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Dữ liệu & Thiết bị</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    <!-- Cấu hình Tailwind cho Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Bật dark mode dựa trên class 'dark'
        }
    </script>
    <style>
        /* Đặt font chữ mặc định */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Thêm font Inter từ Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* CSS cho modal xác nhận */
        #confirmDeleteModal {
            transition: opacity 0.3s ease;
        }

        #confirmDeleteModal .bg-white {
            transition: transform 0.3s ease;
        }

        /* Nút chuyển trạng thái thẻ */
        .status-btn {
            transition: all 0.2s ease;
        }

        .status-btn:hover {
            transform: scale(1.05);
        }

        /* CSS cho thông báo lỗi */
        #errorNotification {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateY(100%);
            opacity: 0;
        }

        #errorNotification.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* CSS cho Spinner loading */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 h-full flex flex-col dark">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-600 h-24 w-24"></div>
        <span class="ml-4 text-white text-lg font-semibold">Đang tải dữ liệu...</span>
    </div>

    <!-- Header -->
    <header class="bg-gray-800 shadow-md p-4 sticky top-0 z-10">
        <div class="container mx-auto max-w-7xl flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                <i class="ph-bold ph-camera"></i>
                <span>Trình quản lý AC / DIT</span>
            </h1>
            <!-- Hiển thị User ID, Tên và Tên chủ sở hữu -->
            <div class="text-right">
                <div class="text-xs text-gray-400">
                    User ID: <span id="userIdDisplay" class="font-mono bg-gray-700 px-2 py-1 rounded">Đang tải...</span>
                </div>
                <!-- Vùng đặt tên hiển thị -->
                <div class="mt-2 flex justify-end gap-2 items-center">
                    <input type="text" id="displayNameInput" placeholder="Đặt tên hiển thị..."
                        class="w-40 bg-gray-700 border border-gray-600 rounded-md shadow-sm px-2 py-1 text-xs text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <button id="saveNameBtn"
                        class="bg-blue-600 text-white font-semibold py-1 px-3 rounded-md shadow-md text-xs hover:bg-blue-700 transition duration-200">
                        Lưu Tên
                    </button>
                </div>
                <!-- Tên chủ sở hữu -->
                <div class="text-xs text-gray-500 mt-1">
                    Created by Thế Nguyên
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="mainContent" class="container mx-auto max-w-7xl p-4 md:p-6 flex-grow hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Cột 1: Quản lý Thiết bị & Lịch sử (ĐÃ DI CHUYỂN LÊN TRÊN) -->
            <div class="space-y-6">
                <!-- Quản lý Thiết bị -->
                <div class="bg-gray-800 shadow-lg rounded-lg overflow-hidden">
                    <div class="p-5 border-b border-gray-700">
                        <h2 class="text-xl font-semibold text-white flex items-center gap-2">
                            <i class="ph-bold ph-camera-plus"></i>
                            Quản lý Thiết bị
                        </h2>
                    </div>

                    <!-- Form Thêm Thiết bị -->
                    <form id="addEquipmentForm" class="p-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="equipmentName" class="block text-sm font-medium text-gray-300 mb-1">Tên Thiết
                                bị</label>
                            <input type="text" id="equipmentName" name="equipmentName"
                                class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="A Cam Body" required>
                        </div>
                        <div>
                            <label for="equipmentCategory"
                                class="block text-sm font-medium text-gray-300 mb-1">Loại</label>
                            <input type="text" id="equipmentCategory" name="equipmentCategory"
                                class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Máy quay" required>
                        </div>
                        <!-- Thêm ô Ghi chú (Notes) -->
                        <div class="sm:col-span-2">
                            <label for="equipmentNotes" class="block text-sm font-medium text-gray-300 mb-1">Ghi chú (Số
                                Seri, Tình trạng...)</label>
                            <textarea id="equipmentNotes" name="equipmentNotes" rows="2"
                                class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Ví dụ: S/N: 12345, Lens bị kẹt focus nhẹ..."></textarea>
                        </div>
                        <button type="submit"
                            class="sm:col-span-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition duration-200">
                            Thêm Thiết bị
                        </button>
                    </form>


                    <!-- Danh sách Thiết bị -->
                    <div class="p-5 space-y-4">
                        <!-- Thanh Tìm kiếm Thiết bị -->
                        <div class="relative">
                            <input type="text" id="searchEquipmentInput"
                                class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm pl-10 pr-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Tìm kiếm thiết bị (theo Tên, Loại, Ghi chú...)">
                            <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>

                        <h3 class="text-lg font-semibold text-gray-200 mb-2">Danh sách thiết bị</h3>
                        <div id="equipmentList" class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                            <!-- Thiết bị sẽ được thêm vào đây bằng JS -->
                        </div>
                    </div>
                </div>

                <!-- Lịch sử Hoạt động (ĐÃ CẬP NHẬT) -->
                <div class="bg-gray-800 shadow-lg rounded-lg overflow-hidden">
                    <div class="p-5 border-b border-gray-700">
                        <h2 class="text-xl font-semibold text-white flex items-center gap-2">
                            <i class="ph-bold ph-clock-counter-clockwise"></i>
                            Lịch sử Hoạt động
                        </h2>
                    </div>
                    <!-- BỘ LỌC NGÀY (MỚI) -->
                    <div class="p-5 flex flex-wrap gap-4 items-center border-b border-gray-700">
                        <label for="historyDateFilter" class="text-sm font-medium text-gray-300 flex-shrink-0">Xem theo
                            ngày:</label>
                        <input type="date" id="historyDateFilter"
                            class="flex-grow bg-gray-700 border border-gray-600 rounded-md shadow-sm px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            style="color-scheme: dark;">
                        <button id="resetHistoryFilter"
                            class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-gray-500 transition duration-200">
                            Xem tất cả
                        </button>
                    </div>
                    <div id="historyLogList" class="p-5 space-y-2 max-h-[300px] overflow-y-auto pr-2">
                        <!-- Log lịch sử sẽ được thêm vào đây -->
                        <p class="text-gray-400 italic">Chưa có hoạt động nào.</p>
                    </div>
                </div>
            </div>

            <!-- Cột 2: Quản lý Thẻ nhớ (DIT Log) -->
            <div class="bg-gray-800 shadow-lg rounded-lg overflow-hidden">
                <div class="p-5 border-b border-gray-700">
                    <h2 class="text-xl font-semibold text-white flex items-center gap-2">
                        <i class="ph-bold ph-hard-drives"></i>
                        Nhật ký Thẻ nhớ (DIT Log)
                    </h2>
                </div>

                <!-- Form Thêm Thẻ -->
                <form id="addCardForm" class="p-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="cardRoll" class="block text-sm font-medium text-gray-300 mb-1">Mã Thẻ (Roll)</label>
                        <input type="text" id="cardRoll" name="cardRoll"
                            class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="A001C001" required>
                    </div>
                    <div>
                        <label for="cardSource" class="block text-sm font-medium text-gray-300 mb-1">Máy quay
                            (Source)</label>
                        <input type="text" id="cardSource" name="cardSource"
                            class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="A Cam" required>
                    </div>
                    <!-- Thêm ô Ghi chú (Notes) -->
                    <div class="sm:col-span-2">
                        <label for="cardNotes" class="block text-sm font-medium text-gray-300 mb-1">Ghi chú (Không bắt
                            buộc)</label>
                        <textarea id="cardNotes" name="cardNotes" rows="2"
                            class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Ví dụ: 256GB, Quay High-speed, Cảnh test..."></textarea>
                    </div>
                    <button type="submit"
                        class="sm:col-span-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200">
                        Thêm Thẻ
                    </button>
                </form>


                <!-- Danh sách Thẻ -->
                <div class="p-5 space-y-4">
                    <!-- Thanh Tìm kiếm Thẻ -->
                    <div class="relative">
                        <input type="text" id="searchCardInput"
                            class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm pl-10 pr-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Tìm kiếm thẻ (theo Mã, Nguồn, Ghi chú...)">
                        <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-200 mb-2">Danh sách thẻ</h3>
                    <div id="cardList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                        <!-- Thẻ sẽ được thêm vào đây bằng JS -->
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal Xác nhận Xóa -->
    <div id="confirmDeleteModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-40 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="confirmDeleteTitle">Xác nhận Xóa</h3>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300" id="confirmDeleteMessage">
                Bạn có chắc chắn muốn xóa mục này không? Hành động này không thể hoàn tác.
            </p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="cancelDeleteBtn"
                    class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200">
                    Hủy
                </button>
                <button type="button" id="confirmDeleteBtn"
                    class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-200">
                    Xóa
                </button>
            </div>
        </div>
    </div>

    <!-- Thông báo lỗi -->
    <div id="errorNotification"
        class="fixed bottom-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-lg z-50 transition-transform duration-300 ease-out translate-y-full opacity-0">
        <strong class="font-bold">Lỗi!</strong>
        <span class="block sm:inline" id="errorMessage">Đã xảy ra lỗi.</span>
    </div>

    <!-- Thông báo thành công (cho việc lưu tên) -->
    <div id="successNotification"
        class="fixed bottom-4 left-4 bg-green-600 text-white p-4 rounded-lg shadow-lg z-50 transition-transform duration-300 ease-out translate-y-full opacity-0">
        <strong class="font-bold">Thành công!</strong>
        <span class="block sm:inline" id="successMessage">Đã lưu tên thành công.</span>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import các hàm từ Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            addDoc,
            Timestamp,
            serverTimestamp
            // orderBy không được dùng để tránh lỗi index, sẽ sort ở client
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";


        // --- BIẾN TOÀN CỤC ---
        let db, auth, userId, appId;
        let userDisplayName = 'Người dùng ẩn danh'; // Tên mặc định
        let cardListContainer = document.getElementById('cardList');
        let equipmentListContainer = document.getElementById('equipmentList');
        let historyLogListContainer = document.getElementById('historyLogList');

        // Biến lưu trữ toàn bộ dữ liệu (để tìm kiếm và lọc)
        let allCards = [];
        let allEquipment = [];
        let allHistoryLogs = []; // MỚI: Biến lưu toàn bộ lịch sử

        // Định nghĩa các bộ sưu tập
        let cardCollectionRef;
        let equipmentCollectionRef;
        let historyCollectionRef;
        let userProfilesCollectionRef; // Collection để lưu tên người dùng

        // Trạng thái modal
        let deleteCallback = null;

        // --- CÁC TRẠNG THÁI (STATUS) ---

        // Trạng thái thẻ nhớ
        const CARD_STATUSES = {
            EMPTY: { text: "Trống", color: "bg-gray-500", next: "RECORDING" },
            RECORDING: { text: "Đang Quay", color: "bg-blue-500", next: "NEEDS_OFFLOAD" },
            NEEDS_OFFLOAD: { text: "Cần Offload", color: "bg-red-600", next: "OFFLOADING" },
            OFFLOADING: { text: "Đang Offload", color: "bg-yellow-500", next: "OFFLOADED" },
            OFFLOADED: { text: "Đã Offload", color: "bg-purple-500", next: "VERIFIED" },
            VERIFIED: { text: "Đã Xác nhận", color: "bg-green-600", next: null } // Trạng thái cuối
        };
        const CARD_STATUS_ORDER = Object.keys(CARD_STATUSES);

        // Trạng thái thiết bị
        const EQUIPMENT_STATUSES = {
            READY: { text: "Sẵn sàng", color: "text-green-400" },
            IN_USE: { text: "Đang dùng", color: "text-blue-400" },
            PREP: { text: "Cần chuẩn bị", color: "text-yellow-400" },
            REPAIR: { text: "Cần sửa chữa", color: "text-red-400" }
        };

        // --- HÀM KHỞI TẠO FIREBASE ---

        async function initializeFirebase() {
            try {
                // Bật log debug của Firestore
                setLogLevel('Debug');

                // --- CẤU HÌNH FIREBASE CỦA BẠN ---
                const firebaseConfig = {
                    apiKey: "AIzaSyDwtPQXujh8xZPu9XDP410_dbS9U4a6Gow",
                    authDomain: "quanlydoanphim.firebaseapp.com",
                    projectId: "quanlydoanphim",
                    storageBucket: "quanlydoanphim.firebasestorage.app",
                    messagingSenderId: "1071085758367",
                    appId: "1:1071085758367:web:faef7aa29409499826bfaa",
                    measurementId: "G-XF4429RBPT"
                };
                // ------------------------------------

                appId = firebaseConfig.appId || 'default-app-id';

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    const errorMsg = "Lỗi: Cấu hình Firebase chưa được thiết lập. " +
                        "Vui lòng tạo dự án Firebase, sao chép cấu hình và dán vào file HTML.";
                    showError(errorMsg);
                    console.error(errorMsg);
                    return;
                }

                // Khởi tạo Firebase App
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Đặt persistence để ưu tiên lưu local
                await setPersistence(auth, browserLocalPersistence);

                // Lắng nghe thay đổi trạng thái Auth
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Người dùng đã đăng nhập:", user.uid);
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        // Khi đã có userId, khởi tạo các đường dẫn collection
                        setupCollections();
                        // Tải tên hiển thị của người dùng
                        await loadUserProfile();
                        // Tải dữ liệu ban đầu
                        attachListeners();
                    } else {
                        console.log("Người dùng chưa đăng nhập, đang thử đăng nhập...");
                        userId = null;
                        document.getElementById('userIdDisplay').textContent = "Đang kết nối...";
                        // Thử đăng nhập (ẩn danh)
                        await attemptSignIn();
                    }
                });

            } catch (error) {
                console.error("Lỗi nghiêm trọng khi khởi tạo Firebase:", error);
                showError("Lỗi khởi tạo Firebase: " + error.message);
                hideLoading();
            }
        }

        // Hàm thử đăng nhập
        async function attemptSignIn() {
            try {
                console.log("Đang thử đăng nhập ẩn danh...");
                await signInAnonymously(auth);
                // onAuthStateChanged sẽ tự động xử lý phần còn lại
            } catch (error) {
                console.error("Lỗi khi đăng nhập (ẩn danh):", error);
                if (error.code === 'auth/operation-not-allowed') {
                    showError("Lỗi đăng nhập: 'Anonymous Sign-in' (Đăng nhập ẩn danh) CHƯA ĐƯỢC BẬT trong Firebase project của bạn.");
                } else {
                    showError("Lỗi đăng nhập: " + error.message);
                }
                hideLoading();
            }
        }

        // --- HÀM THIẾT LẬP COLLECTIONS ---
        function setupCollections() {
            if (!userId || !appId) {
                console.error("Không thể thiết lập collection: userId hoặc appId bị thiếu.");
                return;
            }
            // Quy ước đường dẫn dữ liệu công khai (public)
            const basePath = `artifacts/${appId}/public/data`;
            cardCollectionRef = collection(db, `${basePath}/dit_cards`);
            equipmentCollectionRef = collection(db, `${basePath}/equipment`);
            historyCollectionRef = collection(db, `${basePath}/history_log`);
            // Collection mới để lưu hồ sơ người dùng (tên)
            userProfilesCollectionRef = collection(db, `${basePath}/user_profiles`);
            console.log("Đã thiết lập đường dẫn collections:", basePath);
        }

        // --- HÀM TẢI VÀ LƯU TÊN NGƯỜI DÙNG ---

        // Tải hồ sơ người dùng (tên)
        async function loadUserProfile() {
            if (!userId) return;
            try {
                const userProfileRef = doc(userProfilesCollectionRef, userId);
                const docSnap = await getDoc(userProfileRef);

                if (docSnap.exists()) {
                    userDisplayName = docSnap.data().displayName;
                    document.getElementById('displayNameInput').value = userDisplayName;
                    console.log("Đã tải tên hiển thị:", userDisplayName);
                } else {
                    console.log("Chưa có hồ sơ người dùng, sử dụng tên mặc định.");
                    userDisplayName = `User (${userId.substring(0, 4)})`; // Tên tạm
                }
            } catch (error) {
                console.error("Lỗi khi tải hồ sơ người dùng:", error);
                showError("Lỗi tải tên: " + error.message);
            }
        }

        // Lưu tên hiển thị
        async function handleSaveName(e) {
            e.preventDefault();
            const newName = document.getElementById('displayNameInput').value.trim();
            if (!newName) {
                showError("Tên không được để trống.");
                return;
            }
            if (!userId) {
                showError("Chưa kết nối được với người dùng.");
                return;
            }

            try {
                const userProfileRef = doc(userProfilesCollectionRef, userId);
                await setDoc(userProfileRef, {
                    displayName: newName
                }, { merge: true }); // Dùng setDoc với merge để tạo mới hoặc cập nhật

                userDisplayName = newName; // Cập nhật tên ở local
                showSuccess("Đã lưu tên thành công!");
                console.log("Đã lưu tên:", newName);

            } catch (error) {
                console.error("Lỗi khi lưu tên:", error);
                showError("Lỗi lưu tên: " + error.message);
            }
        }


        // --- HÀM GẮN LISTENER ---
        function attachListeners() {
            if (!cardCollectionRef || !equipmentCollectionRef || !historyCollectionRef) {
                showError("Lỗi: Không thể tải dữ liệu (Collection Refs chưa sẵn sàng).");
                hideLoading();
                return;
            }

            console.log("Đang gắn listeners...");

            // Lắng nghe thay đổi thẻ
            onSnapshot(cardCollectionRef, (snapshot) => {
                allCards = []; // Cập nhật mảng global
                snapshot.forEach(doc => {
                    allCards.push({ id: doc.id, ...doc.data() });
                });
                // Sắp xếp theo thời gian tạo (mới nhất lên đầu)
                allCards.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                renderAndFilterCards(); // Gọi hàm filter/render mới

                console.log("Đã cập nhật danh sách thẻ:", allCards.length);
                hideLoading(); // Ẩn loading sau khi dữ liệu đầu tiên về
            }, (error) => {
                console.error("Lỗi khi tải danh sách thẻ:", error);
                showError("Lỗi tải thẻ: " + error.message);
                hideLoading();
            });

            // Lắng nghe thay đổi thiết bị
            onSnapshot(equipmentCollectionRef, (snapshot) => {
                allEquipment = []; // Cập nhật mảng global
                snapshot.forEach(doc => {
                    allEquipment.push({ id: doc.id, ...doc.data() });
                });
                // Sắp xếp theo tên
                allEquipment.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                renderAndFilterEquipment(); // Gọi hàm filter/render mới

                console.log("Đã cập nhật danh sách thiết bị:", allEquipment.length);
            }, (error) => {
                console.error("Lỗi khi tải danh sách thiết bị:", error);
                showError("Lỗi tải thiết bị: " + error.message);
            });

            // Lắng nghe thay đổi lịch sử (ĐÃ CẬP NHẬT)
            onSnapshot(historyCollectionRef, (snapshot) => {
                allHistoryLogs = []; // Cập nhật mảng global
                snapshot.forEach(doc => {
                    allHistoryLogs.push({ id: doc.id, ...doc.data() });
                });
                // Sắp xếp theo thời gian (mới nhất lên đầu)
                allHistoryLogs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                renderAndFilterHistoryLog(); // Gọi hàm filter/render mới

                console.log("Đã cập nhật lịch sử:", allHistoryLogs.length);
            }, (error) => {
                console.error("Lỗi khi tải lịch sử:", error);
                showError("Lỗi tải lịch sử: " + error.message);
            });
        }

        // --- HÀM HIỂN THỊ (RENDER) ---

        // Hàm Lọc và Render Thẻ
        function renderAndFilterCards() {
            const searchTerm = document.getElementById('searchCardInput').value.toLowerCase();

            const filteredCards = allCards.filter(card => {
                return (
                    (card.roll || '').toLowerCase().includes(searchTerm) ||
                    (card.source || '').toLowerCase().includes(searchTerm) ||
                    (card.notes && card.notes.toLowerCase().includes(searchTerm))
                );
            });

            renderCardList(filteredCards); // Gọi hàm render với dữ liệu đã lọc
        }

        // Hiển thị danh sách thẻ
        function renderCardList(cards) {
            cardListContainer.innerHTML = ''; // Xóa list cũ
            if (cards.length === 0) {
                if (document.getElementById('searchCardInput').value) {
                    cardListContainer.innerHTML = '<p class="text-gray-400 italic">Không tìm thấy thẻ nào.</p>';
                } else {
                    cardListContainer.innerHTML = '<p class="text-gray-400 italic">Chưa có thẻ nào.</p>';
                }
                return;
            }

            cards.forEach(card => {
                const statusInfo = CARD_STATUSES[card.status] || CARD_STATUSES.EMPTY;
                const nextStatusKey = statusInfo.next;
                const nextStatusInfo = nextStatusKey ? CARD_STATUSES[nextStatusKey] : null;

                const cardEl = document.createElement('div');
                cardEl.className = `p-4 rounded-lg shadow-md border-l-4 ${statusInfo.color.replace('bg-', 'border-')} ${statusInfo.color} bg-opacity-20`;
                cardEl.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="text-lg font-bold text-white">${card.roll}</h4>
                    <p class="text-sm text-gray-300">${card.source}</p>
                    <p class="text-xs text-gray-400 mt-1">
                        Trạng thái: <span class="font-semibold ${statusInfo.color} px-2 py-0.5 rounded">${statusInfo.text}</span>
                    </p>
                    <!-- Hiển thị Ghi chú -->
                    ${card.notes ? `
                        <p class="text-sm text-gray-300 mt-2 bg-gray-700 p-2 rounded-md whitespace-pre-wrap font-mono text-xs">
                            <i class="ph ph-note mr-1"></i>${card.notes}
                        </p>
                    ` : ''}
                </div>
                <div class="flex flex-col items-end gap-2 flex-shrink-0 ml-4">
                    ${nextStatusInfo ? `
                        <button data-id="${card.id}" data-current-status="${card.status}" data-next-status="${nextStatusKey}"
                                class="status-btn text-sm font-medium ${nextStatusInfo.color} text-white px-3 py-1 rounded-md shadow-sm hover:opacity-80">
                            <i class="ph-bold ph-arrow-right mr-1"></i>
                            ${nextStatusInfo.text}
                        </button>
                    ` : `
                        <span class="text-sm font-medium text-green-300 px-3 py-1"><i class="ph-bold ph-check-circle"></i> Hoàn tất</span>
                    `}
                    <button data-id="${card.id}" class="delete-card-btn text-gray-400 hover:text-red-500 transition-colors">
                        <i class="ph-bold ph-trash text-lg"></i>
                    </button>
                </div>
            </div>
        `;
                cardListContainer.appendChild(cardEl);
            });

            // Gắn listener cho các nút mới
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', handleChangeCardStatus);
            });
            document.querySelectorAll('.delete-card-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    handleDeleteCard(id);
                });
            });
        }

        // Hàm Lọc và Render Thiết bị
        function renderAndFilterEquipment() {
            const searchTerm = document.getElementById('searchEquipmentInput').value.toLowerCase();

            const filteredEquipment = allEquipment.filter(item => {
                return (
                    (item.name || '').toLowerCase().includes(searchTerm) ||
                    (item.category || '').toLowerCase().includes(searchTerm) ||
                    (item.notes && item.notes.toLowerCase().includes(searchTerm))
                );
            });

            renderEquipmentList(filteredEquipment); // Gọi hàm render với dữ liệu đã lọc
        }

        // Hiển thị danh sách thiết bị
        function renderEquipmentList(equipment) {
            equipmentListContainer.innerHTML = ''; // Xóa list cũ
            if (equipment.length === 0) {
                if (document.getElementById('searchEquipmentInput').value) {
                    equipmentListContainer.innerHTML = '<p class="text-gray-400 italic">Không tìm thấy thiết bị nào.</p>';
                } else {
                    equipmentListContainer.innerHTML = '<p class="text-gray-400 italic">Chưa có thiết bị nào.</p>';
                }
                return;
            }
            equipment.forEach(item => {
                const statusInfo = EQUIPMENT_STATUSES[item.status] || EQUIPMENT_STATUSES.READY;

                // Tạo các option cho select
                let optionsHtml = '';
                for (const key in EQUIPMENT_STATUSES) {
                    optionsHtml += `<option value="${key}" ${item.status === key ? 'selected' : ''}>${EQUIPMENT_STATUSES[key].text}</option>`;
                }

                const itemEl = document.createElement('div');
                itemEl.className = 'p-3 bg-gray-700 rounded-lg flex justify-between items-start gap-4';
                itemEl.innerHTML = `
            <div class="flex-1">
                <h4 class="text-md font-semibold text-white">${item.name}</h4>
                <p class="text-sm text-gray-400">${item.category}</p>
                <!-- Hiển thị Ghi chú -->
                ${item.notes ? `
                    <p class="text-sm text-gray-300 mt-2 bg-gray-600 p-2 rounded-md whitespace-pre-wrap font-mono text-xs">
                        <i class="ph ph-note mr-1"></i>${item.notes}
                    </p>
                ` : ''}
            </div>
            <div class="flex flex-col items-end gap-3 flex-shrink-0">
                <select data-id="${item.id}" data-current-status="${item.status}"
                    class="equipment-status-select bg-gray-600 border border-gray-500 text-white text-sm rounded-md shadow-sm px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 ${statusInfo.color} w-full">
                    ${optionsHtml}
                </select>
                <button data-id="${item.id}" class="delete-equipment-btn text-gray-400 hover:text-red-500 transition-colors">
                    <i class="ph-bold ph-trash text-lg"></i>
                </button>
            </div>
        `;
                equipmentListContainer.appendChild(itemEl);
            });

            // Gắn listener cho các nút/select mới
            document.querySelectorAll('.delete-equipment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    handleDeleteEquipment(id);
                });
            });
            document.querySelectorAll('.equipment-status-select').forEach(select => {
                select.addEventListener('change', handleChangeEquipmentStatus);
            });
        }

        // MỚI: Hàm lọc và render Lịch sử
        function renderAndFilterHistoryLog() {
            const selectedDateStr = document.getElementById('historyDateFilter').value;

            let filteredLogs = allHistoryLogs;

            if (selectedDateStr) { // Nếu có ngày được chọn
                filteredLogs = allHistoryLogs.filter(log => {
                    if (!log.timestamp || !log.timestamp.seconds) return false;

                    const logDate = new Date(log.timestamp.seconds * 1000);
                    // Chuyển đổi sang YYYY-MM-DD ở múi giờ địa phương
                    const logDateStr = logDate.getFullYear() + '-' +
                        ('0' + (logDate.getMonth() + 1)).slice(-2) + '-' +
                        ('0' + logDate.getDate()).slice(-2);

                    return logDateStr === selectedDateStr;
                });
            }

            renderHistoryLog(filteredLogs); // Gọi hàm render với dữ liệu đã lọc (hoặc toàn bộ)
        }

        // MỚI: Hàm helper định dạng ngày
        function formatHistoryDate(date) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            const dateStr = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });

            if (date.toDateString() === today.toDateString()) {
                return `Hôm nay (${dateStr})`;
            }
            if (date.toDateString() === yesterday.toDateString()) {
                return `Hôm qua (${dateStr})`;
            }
            return `Ngày ${dateStr}`;
        }

        // Hiển thị lịch sử (ĐÃ CẬP NHẬT để phân nhóm)
        function renderHistoryLog(logs) {
            historyLogListContainer.innerHTML = ''; // Xóa list cũ

            if (logs.length === 0) {
                if (document.getElementById('historyDateFilter').value) {
                    historyLogListContainer.innerHTML = '<p class="text-gray-400 italic">Không tìm thấy hoạt động nào cho ngày này.</p>';
                } else {
                    historyLogListContainer.innerHTML = '<p class="text-gray-400 italic">Chưa có hoạt động nào.</p>';
                }
                return;
            }

            let currentDayStr = "";
            // Biến này kiểm tra xem có đang lọc theo ngày không
            const isFilteringByDate = !!document.getElementById('historyDateFilter').value;

            logs.forEach(log => {
                if (!log.timestamp || !log.timestamp.seconds) {
                    return; // Bỏ qua log không có timestamp
                }

                const logDate = new Date(log.timestamp.seconds * 1000);

                // Chỉ hiển thị nhóm ngày nếu KHÔNG lọc (xem tất cả)
                if (!isFilteringByDate) {
                    const logDayStr = formatHistoryDate(logDate); // Dùng hàm helper

                    if (logDayStr !== currentDayStr) {
                        currentDayStr = logDayStr;
                        const dateHeader = document.createElement('h4');
                        // Thêm class first:.. để không bị gạch ngang/margin ở header đầu tiên
                        dateHeader.className = "text-md font-semibold text-blue-300 mt-4 pt-2 border-t border-gray-700 first:mt-0 first:pt-0 first:border-t-0";
                        dateHeader.textContent = currentDayStr;
                        historyLogListContainer.appendChild(dateHeader);
                    }
                }

                const logEl = document.createElement('div');
                logEl.className = 'p-2 border-b border-gray-700 last:border-b-0';

                // Luôn hiển thị giờ:phút:giây
                const timestamp = logDate.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                const actor = log.userName || `User (${(log.userId || '...').substring(0, 4)})`;

                logEl.innerHTML = `
            <p class="text-sm text-gray-200"><span class="font-semibold text-blue-300">${actor}</span> ${log.message}</p>
            <p class="text-xs text-gray-400">${timestamp}</p>
        `;
                historyLogListContainer.appendChild(logEl);
            });
        }


        // --- HÀM XỬ LÝ (LOGIC) ---

        // Hàm ghi lịch sử chung
        async function logHistory(message) {
            try {
                await addDoc(historyCollectionRef, {
                    message: message,
                    timestamp: serverTimestamp(),
                    userId: userId,
                    userName: userDisplayName // <-- Thêm tên hiển thị vào log
                });
            } catch (error) {
                console.error("Lỗi khi ghi lịch sử:", error);
                showError("Lỗi ghi lịch sử: " + error.message);
            }
        }

        // Thêm thẻ mới
        async function handleAddCard(e) {
            e.preventDefault();
            const roll = document.getElementById('cardRoll').value;
            const source = document.getElementById('cardSource').value;
            const notes = document.getElementById('cardNotes').value; // Thêm notes
            if (!roll || !source) {
                showError("Vui lòng nhập đầy đủ Mã Thẻ và Máy quay.");
                return;
            }

            try {
                const newCard = {
                    roll: roll,
                    source: source,
                    notes: notes || "", // Lưu notes
                    status: CARD_STATUS_ORDER[0], // Bắt đầu từ 'EMPTY'
                    createdAt: serverTimestamp(),
                    userId: userId,
                    userName: userDisplayName // Lưu lại ai đã tạo
                };
                await addDoc(cardCollectionRef, newCard);
                // Ghi lịch sử (message giờ chỉ cần hành động)
                await logHistory(`đã thêm thẻ ${roll} (${source}).`);
                // Reset form
                e.target.reset();
            } catch (error) {
                console.error("Lỗi khi thêm thẻ:", error);
                showError("Lỗi thêm thẻ: " + error.message);
            }
        }

        // Thay đổi trạng thái thẻ
        async function handleChangeCardStatus(e) {
            const btn = e.currentTarget;
            const id = btn.getAttribute('data-id');
            const currentStatus = btn.getAttribute('data-current-status');
            const nextStatus = btn.getAttribute('data-next-status');

            if (!id || !nextStatus) return;

            try {
                const cardRef = doc(db, cardCollectionRef.path, id);
                await updateDoc(cardRef, {
                    status: nextStatus
                });
                // Ghi lịch sử
                const cardDoc = await getDoc(cardRef);
                const cardRoll = cardDoc.data()?.roll || 'Thẻ không rõ';
                await logHistory(`đã chuyển thẻ ${cardRoll} từ '${CARD_STATUSES[currentStatus].text}' sang '${CARD_STATUSES[nextStatus].text}'.`);

            } catch (error) {
                console.error("Lỗi khi cập nhật trạng thái thẻ:", error);
                showError("Lỗi cập nhật thẻ: " + error.message);
            }
        }

        // Xóa thẻ (mở modal)
        function handleDeleteCard(id) {
            showDeleteConfirm("Xác nhận xóa thẻ", "Bạn có chắc muốn xóa thẻ này?", async () => {
                try {
                    // Lấy thông tin thẻ trước khi xóa để ghi log
                    const cardRef = doc(db, cardCollectionRef.path, id);
                    const cardDoc = await getDoc(cardRef);
                    const cardRoll = cardDoc.data()?.roll || 'Thẻ không rõ';

                    await deleteDoc(cardRef);
                    await logHistory(`đã xóa thẻ ${cardRoll}.`);
                    hideDeleteConfirm();
                } catch (error) {
                    console.error("Lỗi khi xóa thẻ:", error);
                    showError("Lỗi xóa thẻ: " + error.message);
                    hideDeleteConfirm();
                }
            });
        }

        // Thêm thiết bị mới
        async function handleAddEquipment(e) {
            e.preventDefault();
            const name = document.getElementById('equipmentName').value;
            const category = document.getElementById('equipmentCategory').value;
            const notes = document.getElementById('equipmentNotes').value; // Thêm notes
            if (!name || !category) {
                showError("Vui lòng nhập Tên và Loại thiết bị.");
                return;
            }

            try {
                await addDoc(equipmentCollectionRef, {
                    name: name,
                    category: category,
                    notes: notes || "", // Lưu notes
                    status: 'READY', // Mặc định là 'Sẵn sàng'
                    createdAt: serverTimestamp(),
                    userId: userId,
                    userName: userDisplayName // Lưu lại ai đã tạo
                });
                // Ghi lịch sử
                await logHistory(`đã thêm thiết bị ${name} (${category}).`);
                // Reset form
                e.target.reset();
            } catch (error) {
                console.error("Lỗi khi thêm thiết bị:", error);
                showError("Lỗi thêm thiết bị: " + error.message);
            }
        }

        // Thay đổi trạng thái thiết bị
        async function handleChangeEquipmentStatus(e) {
            const select = e.currentTarget;
            const id = select.getAttribute('data-id');
            const newStatus = select.value;
            const currentStatus = select.getAttribute('data-current-status');

            if (newStatus === currentStatus) return; // Không thay đổi

            try {
                const equipmentRef = doc(db, equipmentCollectionRef.path, id);
                await updateDoc(equipmentRef, {
                    status: newStatus
                });
                // Cập nhật lại attribute để lần sau so sánh cho đúng
                select.setAttribute('data-current-status', newStatus);

                // Ghi lịch sử
                const eqDoc = await getDoc(equipmentRef);
                const eqName = eqDoc.data()?.name || 'Thiết bị không rõ';
                await logHistory(`đã chuyển trạng thái thiết bị ${eqName} từ '${EQUIPMENT_STATUSES[currentStatus].text}' sang '${EQUIPMENT_STATUSES[newStatus].text}'.`);

                // Cập nhật màu sắc của select
                const statusInfo = EQUIPMENT_STATUSES[newStatus] || EQUIPMENT_STATUSES.READY;
                // Xóa các class màu cũ
                Object.values(EQUIPMENT_STATUSES).forEach(s => select.classList.remove(s.color));
                // Thêm class màu mới
                select.classList.add(statusInfo.color);

            } catch (error) {
                console.error("Lỗi khi cập nhật trạng thái thiết bị:", error);
                showError("Lỗi cập nhật thiết bị: " + error.message);
                // Reset select về trạng thái cũ nếu lỗi
                select.value = currentStatus;
            }
        }

        // Xóa thiết bị (mở modal)
        function handleDeleteEquipment(id) {
            showDeleteConfirm("Xác nhận xóa thiết bị", "Bạn có chắc muốn xóa thiết bị này?", async () => {
                try {
                    // Lấy thông tin trước khi xóa
                    const equipmentRef = doc(db, equipmentCollectionRef.path, id);
                    const eqDoc = await getDoc(equipmentRef);
                    const eqName = eqDoc.data()?.name || 'Thiết bị không rõ';

                    await deleteDoc(equipmentRef);
                    await logHistory(`đã xóa thiết bị ${eqName}.`);
                    hideDeleteConfirm();
                } catch (error) {
                    console.error("Lỗi khi xóa thiết bị:", error);
                    showError("Lỗi xóa thiết bị: " + error.message);
                    hideDeleteConfirm();
                }
            });
        }


        // --- HÀM TIỆN ÍCH (UI) ---

        // Hiển thị/ẩn Loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            showMainContent(); // Hiển thị nội dung chính khi hết loading
        }

        function showMainContent() {
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // Hiển thị thông báo lỗi
        function showError(message) {
            const errorEl = document.getElementById('errorNotification');
            document.getElementById('errorMessage').textContent = message;
            errorEl.classList.add('show');
            // Tự động ẩn sau 5 giây
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }

        // Hiển thị thông báo thành công
        function showSuccess(message) {
            const successEl = document.getElementById('successNotification');
            document.getElementById('successMessage').textContent = message;
            successEl.classList.remove('translate-y-full', 'opacity-0');
            // Tự động ẩn sau 3 giây
            setTimeout(() => {
                successEl.classList.add('translate-y-full', 'opacity-0');
            }, 3000);
        }

        // Hiển thị/ẩn Modal xác nhận
        function showDeleteConfirm(title, message, onConfirm) {
            document.getElementById('confirmDeleteTitle').textContent = title;
            document.getElementById('confirmDeleteMessage').textContent = message;
            deleteCallback = onConfirm; // Lưu hàm callback

            const modal = document.getElementById('confirmDeleteModal');
            modal.classList.remove('hidden');
            setTimeout(() => { // Delay nhỏ để transition hoạt động
                modal.classList.remove('opacity-0');
                modal.querySelector('.bg-white').classList.remove('scale-95');
            }, 10);
        }

        function hideDeleteConfirm() {
            const modal = document.getElementById('confirmDeleteModal');
            modal.classList.add('opacity-0');
            modal.querySelector('.bg-white').classList.add('scale-95');
            setTimeout(() => { // Chờ transition kết thúc
                modal.classList.add('hidden');
                deleteCallback = null; // Xóa callback
            }, 300);
        }

        // Hàm xử lý khi nhấn nút "Xóa" trên modal
        function handleConfirmDelete() {
            if (typeof deleteCallback === 'function') {
                deleteCallback();
            }
            // hideDeleteConfirm() sẽ được gọi bên trong hàm callback (sau khi xóa xong)
        }


        // --- ĐĂNG KÝ SỰ KIỆN BAN ĐẦU ---

        // Form thêm thẻ
        document.getElementById('addCardForm').addEventListener('submit', handleAddCard);
        // Form thêm thiết bị
        document.getElementById('addEquipmentForm').addEventListener('submit', handleAddEquipment);
        // Nút Hủy và Xác nhận Xóa trên Modal
        document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteConfirm);
        document.getElementById('confirmDeleteBtn').addEventListener('click', handleConfirmDelete);
        // Nút Lưu Tên
        document.getElementById('saveNameBtn').addEventListener('click', handleSaveName);

        // Thanh Tìm kiếm
        document.getElementById('searchCardInput').addEventListener('input', renderAndFilterCards);
        document.getElementById('searchEquipmentInput').addEventListener('input', renderAndFilterEquipment);

        // MỚI: Lịch sử Hoạt động - Bộ lọc ngày
        document.getElementById('historyDateFilter').addEventListener('change', renderAndFilterHistoryLog);
        document.getElementById('resetHistoryFilter').addEventListener('click', () => {
            document.getElementById('historyDateFilter').value = ""; // Xóa giá trị date picker
            renderAndFilterHistoryLog(); // Render lại
        });

        // --- KHỞI CHẠY ỨNG DỤNG ---
        // Bắt đầu quá trình khởi tạo Firebase
        initializeFirebase();

    </script>
</body>

</html>

